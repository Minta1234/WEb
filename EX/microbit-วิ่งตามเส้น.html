<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>DOOM + micro:bit (USB)</title>

<style>
body {
    margin: 0;
    background: black;
    color: #0f0;
    font-family: monospace;
}
#bar {
    padding: 6px;
    background: #111;
}
button {
    padding: 6px 12px;
    font-weight: bold;
}
canvas {
    display: block;
    width: 1920px;
    height: 1080px;
    image-rendering: pixelated;
}
</style>

<script src="https://js-dos.com/6.22/current/js-dos.js"></script>
</head>

<body>

<div id="bar">
    <button onclick="connect()">CONNECT USB micro:bit</button>
    <span id="state">DISCONNECTED</span>
</div>

<canvas id="screen" width="1920" height="1080"></canvas>

<script>
let port, reader, doom;

/* ================= DOOM ================= */
Dos(document.getElementById("screen"), {
    wdosboxUrl: "https://js-dos.com/6.22/current/wdosbox.js",
}).ready((fs, main) => {
    doom = main;
    fs.extract("https://js-dos.com/cdn/upload/DOOM-@evilution.zip").then(() => {
        main(["-c", "doom.exe"], { fullscreen: true });
    });
});

/* =============== USB SERIAL ============== */
async function connect() {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });

    const decoder = new TextDecoderStream();
    port.readable.pipeTo(decoder.writable);
    reader = decoder.readable.getReader();

    document.getElementById("state").textContent = "CONNECTED";

    while (true) {
        const { value } = await reader.read();
        if (value) parse(value.trim());
    }
}

/* ============== INPUT MAP =============== */
function key(k) {
    doom.simulateKeyPress(k);
}

function parse(cmd) {
    console.log(cmd);
    switch (cmd) {
        case "UP":    key("ArrowUp"); break;
        case "DOWN":  key("ArrowDown"); break;
        case "LEFT":  key("ArrowLeft"); break;
        case "RIGHT": key("ArrowRight"); break;
        case "FIRE":  key("Control"); break;
    }
}
</script>

</body>
</html>
