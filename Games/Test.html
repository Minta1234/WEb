<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Road Surface 3D Analyzer</title>

<style>
:root{
 --bg:#0b0e14;
 --accent:#00ffcc;
}
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:var(--bg);color:#eaeaea}
h1{text-align:center;margin:12px 0}
button{
 padding:8px 14px;border:0;border-radius:8px;
 background:var(--accent);color:#000;font-weight:600;margin:4px
}
#controls{text-align:center}
.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
 gap:12px;padding:12px
}
.card{background:#111;border-radius:12px;padding:10px}
.value{font-size:14px;opacity:.85}
canvas{width:100%;height:120px;background:#05070b;border-radius:8px}
video{display:none}
</style>
</head>

<body>
<h1>ðŸ›£ Road Surface 3D Analyzer</h1>

<div id="controls">
 <button onclick="saveCSV()">ðŸ’¾ Export CSV</button>
 <button onclick="exportPLY()">ðŸ§Š Export 3D</button>
</div>

<div class="grid">
 <div class="card">
  <h3>Light Intensity</h3>
  <div id="lightVal" class="value">-</div>
  <canvas id="lightGraph"></canvas>
 </div>

 <div class="card">
  <h3>Vertical Roughness (VRI)</h3>
  <div id="vriVal" class="value">-</div>
  <canvas id="vriGraph"></canvas>
 </div>

 <div class="card">
  <h3>Distance</h3>
  <div id="distVal" class="value">0 m</div>
 </div>
</div>

<video id="cam" autoplay playsinline></video>

<script>
/* ================= STATE ================= */
let speed=0
let distance=0
let lastT=Date.now()

let accZ=0
let lastLight=0

const accBuf=[]
const log=[]
const points3D=[]

/* ================= GRAPH ================= */
function drawGraph(ctx,data,color){
 ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height)
 ctx.strokeStyle=color
 ctx.beginPath()
 let m=Math.max(...data,1)
 data.forEach((v,i)=>{
  let x=i*(ctx.canvas.width/(data.length-1))
  let y=ctx.canvas.height-(v/m)*ctx.canvas.height
  i?ctx.lineTo(x,y):ctx.moveTo(x,y)
 })
 ctx.stroke()
}

/* ================= CAMERA â†’ LIGHT ONLY ================= */
const cam=document.getElementById("cam")
const lightCtx=lightGraph.getContext("2d")
let lightData=[]

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>{
 cam.srcObject=s
 const c=document.createElement("canvas"),ctx=c.getContext("2d")

 setInterval(()=>{
  c.width=cam.videoWidth
  c.height=cam.videoHeight
  ctx.drawImage(cam,0,0)

  let d=ctx.getImageData(0,0,c.width,c.height).data
  let sum=0
  for(let i=0;i<d.length;i+=4)
   sum+=(d[i]+d[i+1]+d[i+2])/3

  let light=sum/(d.length/4)
  lightVal.textContent=light.toFixed(0)

  lightData.push(light)
  if(lightData.length>60) lightData.shift()
  drawGraph(lightCtx,lightData,"#00ffcc")

  updateSurface(light)

 },400)
})

/* ================= ACC (VERTICAL) ================= */
addEventListener("devicemotion",e=>{
 accZ=e.accelerationIncludingGravity?.z||0
})

function computeVRI(){
 accBuf.push(accZ)
 if(accBuf.length>25) accBuf.shift()
 let rms=Math.sqrt(accBuf.reduce((s,v)=>s+v*v,0)/accBuf.length)
 return rms
}

/* ================= GPS SPEED ================= */
navigator.geolocation.watchPosition(p=>{
 speed=p.coords.speed||0
},{enableHighAccuracy:true})

/* ================= CORE ANALYSIS ================= */
const vriCtx=vriGraph.getContext("2d")
let vriData=[]

function updateSurface(light){
 let now=Date.now()
 let dt=(now-lastT)/1000
 lastT=now

 distance+=speed*dt
 distVal.textContent=distance.toFixed(1)+" m"

 let vri=computeVRI()
 vriVal.textContent=vri.toFixed(3)

 let lgi=(light-lastLight)/(speed*dt||0.01)
 lastLight=light

 vriData.push(vri)
 if(vriData.length>60) vriData.shift()
 drawGraph(vriCtx,vriData,"#ffb300")

 /* 3D POINT */
 let z=vri*2 + Math.abs(lgi)*0.01
 let c=Math.min(255,Math.max(0,light))

 points3D.push({
  x:distance,
  y:0,
  z:z,
  r:c,
  g:255-c,
  b:80
 })

 /* CSV LOG (UNIFIED) */
 log.push({
  timestamp:now,
  distance_m:distance,
  speed_ms:speed,
  light:light,
  light_gradient:lgi,
  acc_vertical:accZ,
  vri:vri,
  surface_z:z
 })
}

/* ================= EXPORT CSV ================= */
function saveCSV(){
 if(log.length<10){
  alert("Not enough data")
  return
 }
 let header=Object.keys(log[0]).join(",")
 let rows=log.map(r=>Object.values(r).join(","))
 let csv=[header,...rows].join("\n")

 let a=document.createElement("a")
 a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}))
 a.download="road_surface_log.csv"
 a.click()
}

/* ================= EXPORT PLY ================= */
function exportPLY(){
 let h=
`ply
format ascii 1.0
element vertex ${points3D.length}
property float x
property float y
property float z
property uchar red
property uchar green
property uchar blue
end_header\n`

 let b=points3D.map(p=>
  `${p.x.toFixed(3)} ${p.y} ${p.z.toFixed(3)} ${p.r} ${p.g} ${p.b}`
 ).join("\n")

 let a=document.createElement("a")
 a.href=URL.createObjectURL(new Blob([h+b]))
 a.download="road_surface_3d.ply"
 a.click()
}
</script>
</body>
</html>
